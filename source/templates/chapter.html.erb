---
layout: layout
---

<%= partial "layouts/partials/header" %>

<article class="chapter theme-<%= locals[:color] %>">
    <header class="chapter-hero">
        <h1 class="hero-headline"><%= locals[:title].titleize %></h1>
    </header>

    <!-- Introduction -->
    <div class="chapter-section first l-wrapper narrow" id="intro">
        <%# https://forum.middlemanapp.com/t/sitemap-where-querying-the-sitemap/1241/2 %>
        <% sitemap.where(:chapter => locals[:slug], :type => "introduction").order_by(:order).all.each do |intro| %>
            <%# http://stackoverflow.com/questions/25219509/how-to-get-the-raw-content-from-all-pages %>
            <%= intro.render %>
        <% end %>
    </div>

    <!-- Sections -->
    <% sitemap.where(:chapter => locals[:slug]).order_by(:order).all.each do |section| %>
        <% unless section.data.type == "introduction" %>
            <section class="chapter-section<% if section.data.type.present? %> <%= section.data.type %><% end %>" id="composition">
                <h2 class="chapter-subtitle"><%= section.data.title %></h2>
                <div class="l-wrapper narrow">
                    <%= section.render %>
                </div>
            </section>
        <% end %>
    <% end %>
</article>

<%# set up an array of the local data for pagination %>
<%# -> so we can access chapters via index %>
<%
    @chapter_slugs = []
    data.chapters.each do |chapter|
        @chapter_slugs.push(chapter.slug)
    end
    @current_index = @chapter_slugs.index(locals[:slug])
    @prev_path = "#{data.site.paths.chapter}#{@chapter_slugs[@current_index - 1].to_s.urlize}/"
    @next_path = "#{data.site.paths.chapter}#{@chapter_slugs[@current_index + 1].to_s.urlize}/"

    @chapter_titles = []
    data.chapters.each do |chapter|
        @chapter_titles.push(chapter.title)
    end
    @prev_title = @chapter_titles[@current_index - 1]
    @next_title = @chapter_titles[@current_index + 1]
%>


<!-- Local navigation (next/prev chapters) -->
<nav class="pagination">
    <h2 class="pagination-slug">Read more</h2>
    <ul class="l-wrapper">
        <% if @current_index > 0 %>
        <li class="pagination-prev">
            <a href="<%= @prev_path %>">
                <span class="pagination-subtitle">Previous</span>
                <strong class="pagination-title"><%= @prev_title %></strong>
            </a>
        </li>
        <% end %>
        <% if @current_index < @chapter_slugs.length - 1 %>
        <li class="pagination-next">
            <a href="<%= @next_path %>">
                <span class="pagination-subtitle">Next</span>
                <strong class="pagination-title"><%= @next_title %></strong>
            </a>
        </li>
        <% end %>
    </ul>
</nav>
